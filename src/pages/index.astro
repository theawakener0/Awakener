---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Biography from '../components/Biography.astro';
import ToolStack from '../components/ToolStack.astro';
import ProjectCard from '../components/ProjectCard.astro';
import { getPinnedRepos, getFallbackRepos, type PinnedRepo } from '../lib/github';
import { getCollection, type CollectionEntry } from 'astro:content';

const repos = await getPinnedRepos('theawakener0');
const projects: PinnedRepo[] = repos.length > 0 ? repos : getFallbackRepos();

function getReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.trim().split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

const allPosts: CollectionEntry<'blog'>[] = await getCollection('blog');
const posts = allPosts
  .sort((a: CollectionEntry<'blog'>, b: CollectionEntry<'blog'>) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3)
  .map((post: CollectionEntry<'blog'>) => ({
    ...post,
    readingTime: getReadingTime(post.body)
  }));
---

<BaseLayout title="Awakener" description="AI engineer | System engineer.">
  <Header />
  
  <main>
    <!-- Hero -->
    <section class="min-h-screen flex items-center justify-center px-6">
      <div class="text-center max-w-3xl stagger">
        <h1 class="font-serif text-5xl sm:text-6xl md:text-7xl lg:text-8xl mb-8 tracking-tight leading-none">
          Awakener
        </h1>
        <p class="font-mono text-base sm:text-lg md:text-xl text-secondary max-w-xl mx-auto leading-relaxed">
          AI Engineer | System Engineer<span class="cursor-blink">_</span>
        </p>
      </div>
    </section>
    
    <!-- Biography -->
    <Biography />
    
    <!-- Tool Stack -->
    <ToolStack />
    
    <!-- Projects -->
    <section class="py-20 sm:py-24 md:py-32 px-6" id="projects">
      <div class="max-w-6xl mx-auto">
        <h2 class="font-serif text-3xl sm:text-4xl md:text-5xl mb-10 sm:mb-12">Projects</h2>
        
        {projects.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            {projects.map((repo: PinnedRepo) => (
              <ProjectCard repo={repo} />
            ))}
          </div>
        ) : (
          <p class="font-mono text-secondary">No projects found.</p>
        )}
        
        <a 
          href="https://github.com/theawakener0"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-block font-mono text-sm text-secondary hover:text-white mt-8 sm:mt-10 link-underline"
        >
          View all on GitHub →
        </a>
      </div>
    </section>
    
    <!-- Writing -->
    <section class="py-20 sm:py-24 md:py-32 px-6" id="writing">
      <div class="max-w-6xl mx-auto">
        <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4 mb-10 sm:mb-12">
          <h2 class="font-serif text-3xl sm:text-4xl md:text-5xl">Writing</h2>
          {posts.length > 0 && (
            <a 
              href="/blog"
              class="font-mono text-sm text-secondary hover:text-white link-underline"
            >
              View all posts →
            </a>
          )}
        </div>
        
        {posts.length > 0 ? (
          <div class="border-t border-subtle">
            {posts.map((post) => (
              <a 
                href={`/blog/${post.slug}`}
                class="block py-6 sm:py-8 border-b border-subtle hover-lift group"
              >
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-4">
                  <div class="flex-1">
                    <h3 class="font-mono text-base sm:text-lg text-white group-hover:opacity-80 transition-opacity">
                      {post.data.title}
                    </h3>
                    <p class="font-mono text-sm text-secondary mt-1 sm:mt-2 line-clamp-2">
                      {post.data.description}
                    </p>
                  </div>
                  <div class="font-mono text-xs text-secondary flex-shrink-0">
                    {post.data.pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                  </div>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <p class="font-mono text-secondary py-12">No posts yet.</p>
        )}
      </div>
    </section>
    
    <!-- Footer -->
    <footer class="py-12 sm:py-16 px-6">
      <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-center sm:items-start justify-between gap-6">
        <p class="font-mono text-sm text-secondary text-center sm:text-left">
          © 2026 — Built with Astro
        </p>
        <a 
          href="https://github.com/theawakener0"
          target="_blank"
          rel="noopener noreferrer"
          class="font-mono text-sm text-secondary hover:text-white link-underline"
        >
          GitHub
        </a>
      </div>
    </footer>
  </main>
</BaseLayout>

<style>
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }
  
  .cursor-blink {
    animation: blink 1s step-end infinite;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
